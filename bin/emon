#!/usr/bin/env ruby

path = ARGV[0] || `v`.split(':').first

def run_test(test_path)
  test_path = test_path.sub(/.*apps\/.*?\//, "") # account for umbrella apps
  cmd = ["nodemon",
         "--verbose",
         "--ignore", "erl_crash.dump",
         "--ignore", "deps",
         "--ignore", "_build",
         "--watch", ".",
         "--ext", "ex exs",
         "--exec", "mix test #{test_path}"]
  system(*cmd)
end

if /_test\.exs/.match(path)
  run_test(path)
else
  test_filename = File.basename(path.gsub(/\.ex$/, '_test.exs'))
  test_path = Dir.glob(File.join("**", test_filename)).first
  if test_path
    run_test(test_path)
  else
    puts "Cannot figure out which test to run from: #{path.inspect}"
  end
end
