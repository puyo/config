#!/usr/bin/env ruby

require 'shellwords'

path = ARGV[0] || `v`.split(':').first

def run_test(test_path)
  test_path = test_path.sub(/.*apps\/.*?\//, "") # account for umbrella apps
  cmd = ["nodemon",
         "--verbose",
         "--ignore", "**/TAGS",
         "--ignore", "**/tags",
         "--ignore", "**/*.dump",
         "--ignore", "**/*.beam",
         "--ignore", "**/deps/**/*",
         "--ignore", "**/_build/**/*",
         "--watch", ".",
         "--ext", "ex exs",
         "--exec", "mix test --color #{test_path}"]
  cmd_s = Shellwords.join(cmd)
  cmd_s = "(#{cmd_s} 2>&1) | grep -E -v '(^Test patterns did not match|^==>)'"
  puts cmd_s
  system cmd_s
end

if /_test\.exs/.match(path)
  run_test(path)
else
  test_filename = File.basename(path.gsub(/\.ex$/, '_test.exs'))
  test_path = Dir.glob(File.join("**", test_filename)).first
  if test_path
    run_test(test_path)
  else
    puts "Cannot figure out which test to run from: #{path.inspect}"
  end
end
