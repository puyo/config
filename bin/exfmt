#!/usr/bin/env ruby

# Wraps around Elixir 1.6 `mix format -` to preserve leading space, so I can run
# :!exfmt in Vim or Spacemacs to format highlighted Elixir code.

ENV['ASDF_ELIXIR_VERSION'] = '1.6.6'

if ARGV.empty?
  input = ARGF.read

  leading = input.match(/\A(^\s+\n)*/m).captures.first
  indent = input.match(/([ \t]*)\S/).captures.first
  trailing = input.match(/(^\s+\n)*\Z/m).captures.first

  leading.each_line { print "\n" }
  IO.popen(['mix', 'format', '-'], 'r+') do |pipe|
    pipe.print input
    pipe.close_write
    pipe.readlines.each do |line|
      $stdout.print indent if line.strip != ''
      $stdout.print line
    end
  end
  trailing.each_line { print "\n" }
else
  exec('mix', 'format', *ARGV)
end
