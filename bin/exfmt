#!/usr/bin/env ruby

# Wraps around Elixir 1.6 `mix format -` to preserve leading space, so I can run
# :!exfmt in Vim or Spacemacs to format highlighted Elixir code.

ENV['ASDF_ELIXIR_VERSION'] = '1.6.6'

if ARGV.empty?
  input = ARGF.read
  leading_space = input.match(/(\s+)/).captures.first

  IO.popen(['mix', 'format', '-'], "r+") do |pipe|
    pipe.print input
    pipe.close_write
    pipe.readlines.each do |line|
      $stdout.print leading_space if line.strip != ''
      $stdout.print line
    end
  end
else
  exec('mix', 'format', *ARGV)
end
