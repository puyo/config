#!/usr/bin/env ruby

# Wraps around Elixir 1.6 `mix format -` to preserve leading space, so I can run
# :!exfmt in Vim or Spacemacs to format highlighted Elixir code.

ENV['ASDF_ELIXIR_VERSION'] = '1.6.6'
ENV['MIX_QUIET'] = '1'

module Exfmt
  class << self
    def format(input, output_stream)
      format_asdf(input, output_stream)
    end

    private

    def format_fork(input, output_stream)
      project = File.join(ENV['HOME'], 'projects', 'elixir')
      elixir = File.join(project, 'bin', 'elixir')
      mix = File.join(project, 'bin', 'mix')
      IO.popen([elixir, mix, 'format', '-'], 'r+') do |pipe|
        pipe.print input
        pipe.close_write
        pipe.each_line do |line|
          output_stream.print line
        end
      end
    end

    def format_asdf(input, output_stream)
      leading = leading(input)
      indent = indent(input)
      trailing = trailing(input)

      output_stream.print leading
      IO.popen(['mix', 'format', '-'], 'r+') do |pipe|
        pipe.print input
        pipe.close_write
        pipe.each_line do |line|
          output_stream.print indent if line != ''
          output_stream.print line
        end
      end
      output_stream.print trailing
    end

    def leading(input)
      m = input.match(/\A(\s*\n)*/m)
      m && m.captures.first || ''
    end

    def trailing(input)
      m = input.match(/^(\s*\n)*\Z/m)
      m && m.captures.first || ''
    end

    def indent(input)
      m = input.match(/([ \t]*)\S/)
      m && m.captures.first || ''
    end
  end
end

if ARGV.first == '--test'
  require 'minitest/autorun'
  require 'minitest/pride'
  require 'stringio'

  ARGV.shift

  class TestExfmt < Minitest::Test
    def test_complex_simple
      input = <<-ELIXIR
        {:ok, _} = @client.create_matches([%{student: student, ext_student: ext_student}], school, :student_matches)
      ELIXIR
      expected = <<-ELIXIR
        {:ok, _} =
          @client.create_matches(
            [%{student: student, ext_student: ext_student}],
            school,
            :student_matches
          )
      ELIXIR
      output_stream = StringIO.new
      Exfmt.format(input, output_stream)
      assert_equal expected, output_stream.string
    end

    def test_complex_example
      input = <<-ELIXIR

        with {:ok, school} <- @client.get_school(:ext, object[:school]),
            student_attributes <- map.put(student_attributes, :"school-id", school.id),
            {:ok, student} <- @client.create_student(student_attributes),
            {:ok, _} <- @client.create_matches([%{student: student, ext_student: ext_student}], school, :student_matches) do
          :ok
        end


      ELIXIR
      expected = <<-ELIXIR

        with {:ok, school} <- @client.get_school(:ext, object[:school]),
             student_attributes <- map.put(student_attributes, :"school-id", school.id),
             {:ok, student} <- @client.create_student(student_attributes),
             {:ok, _} <-
               @client.create_matches(
                 [%{student: student, ext_student: ext_student}],
                 school,
                 :student_matches
               ) do
          :ok
        end


      ELIXIR
      output_stream = StringIO.new
      Exfmt.format(input, output_stream)
      assert_equal expected, output_stream.string
    end
  end

  exit 0
elsif ARGV.empty?
  Exfmt.format(ARGF.read, $stdout)
else
  exec('mix', 'format', *ARGV)
end
