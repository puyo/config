#!/usr/bin/env ruby

# Similar to this:
#
#     #!/bin/bash
#
#     emacsclient -nq "${@}" 2> /dev/null || emacs --chdir "${PWD}" "${@}" &
#
# But it handles input like this:
#
#     e f1.js:20 f2.js:30
#
# Which opens f1.js and f2.js at line numbers 20 and 30 respectively.
#
# It opens the current directory if no arguments are provided.

require 'open3'

emacs = '/usr/local/bin/emacs'
emacsclient = '/usr/local/bin/emacsclient'

args = if ARGV.any?
         ARGV.map do |arg|
           file, line, col = arg.split(':')
           file.gsub!(%r{^[ab]/}, '') # git diff
           if line && col
             ["+#{line}:#{col}", file]
           elsif line
             ["+#{line}", file]
           else
             arg
           end
         end.flatten
       else
         ['.']
       end

Open3.popen2e(emacsclient, '-nq', *args) do |_, _, wait_thr|
  exit_status = wait_thr.value
  exit_status.success? || Process.spawn(emacs, '--chdir', Dir.pwd, *args)
end
